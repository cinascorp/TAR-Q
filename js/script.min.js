(function(){const TILE_URLS=['https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}','https://www.tile.openstreetmap.org/{z}/{x}/{y}.png',];const COLORS={privat:getCssVar('--privat'),military:getCssVar('--mil'),passenger:getCssVar('--passenger'),commercial:getCssVar('--commercial'),droneLow:getCssVar('--droneLow'),droneHigh:getCssVar('--droneHigh')};const DRONE_SVG=`data:image/svg+xml;utf8,${encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="white"><path d="M12 10a2 2 0 100 4 2 2 0 000-4zm-7-2l3 1 2-1 1 2-1 2-2-1-3 1 1-3-1-2zm14 0l-3 1-2-1-1 2 1 2 2-1 3 1-1-3 1-2zM5 17l3-1 2 1 1-2-1-2-2 1-3-1 1 3-1 2zm14 0l-3-1-2 1-1-2 1-2 2 1 3-1-1 3 1 2z"/></svg>')}`;const DRONE_SVG_BLACK=`data:image/svg+xml;utf8,${encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="black"><path d="M12 10a2 2 0 100 4 2 2 0 000-4zm-7-2l3 1 2-1 1 2-1 2-2-1-3 1 1-3-1-2zm14 0l-3 1-2-1-1 2 1 2 2-1 3 1-1-3 1-2zM5 17l3-1 2 1 1-2-1-2-2 1-3-1 1 3-1 2zm14 0l-3-1-2 1-1-2 1-2 2 1 3-1-1 3 1 2z"/></svg>')}`;const HELI_SVG=`data:image/svg+xml;utf8,${encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="gray"><path d="M3 12h10a4 4 0 110 8H8a5 5 0 01-5-5v-3zm14-6h-4a1 1 0 110-2h9a1 1 0 110 2h-3v5h-2V6z"/></svg>')}`;const AIRPLANE_SVG=`data:image/svg+xml;utf8,${encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="azure"><path d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z"/></svg>')}`;const AIRPLANE_SMALL_SVG=`data:image/svg+xml;utf8,${encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill=""><path d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z"/></svg>')}`;const AIRPLANE_PROP_SVG=`data:image/svg+xml;utf8,${encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill=""><path d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z"/></svg>')}`;const FIGHTER_SVG = `data:image/svg+xml;utf8,${encodeURIComponent('<svg width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path fill="red" stroke="#000000" stroke-width="0.4" transform="rotate(-90 12 12)" d="M23.25 14.25q0 0.35-3.35 1.1l-4.1 0.35l-2.6 0.75h-0.75l-3.4 4.1h0.8q0.3 0 0.5 0.05t0.25 0.15-0.25 0.15-0.5 0.05h-1.1-1.85-0.75v-0.35h0.75v-4.85h-1.85l-2.25 2.6h-1.1l-0.35-0.35v-2.25h0.35v-0.35h1.5v-0.1l-2.25-0.25v-1.5l2.25-0.25v-0.1h-1.5v-0.35h-0.35v-2.25l0.35-0.35h1.1l2.25 2.6h1.85v-4.85h-0.75v-0.35h0.75 1.85 1.1q0.3 0 0.5 0.05t0.25 0.15-0.25 0.15-0.5 0.05h-0.8l3.4 4.1h0.75l2.6 0.75 4.1 0.35q3.05 0.7 3.35 1.05z"/></svg>')}`;document.getElementById('legend-heli-menu').style.backgroundImage=`url(${HELI_SVG})`;document.getElementById('legend-heli-menu').style.backgroundSize='contain';document.getElementById('legend-heli-menu').style.backgroundRepeat='no-repeat';function updateDroneLegendIcons(){const el=document.getElementById('legend-drone-menu');if(!el)return;const src=(currentMapLayer==='dark')?DRONE_SVG_BLACK:DRONE_SVG;el.style.backgroundImage=`url(${src})`;el.style.backgroundSize='contain';el.style.backgroundRepeat='no-repeat'} const baseLayer=new ol.layer.Tile({source:new ol.source.XYZ({url:TILE_URLS[0],attributions:'© ArcGIS, © OpenStreetMap'})});const brightLayer=new ol.layer.Tile({source:new ol.source.XYZ({url:'https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}',attributions:'© ESRI'}),visible:!1});const trackLayer=new ol.layer.Vector({source:new ol.source.Vector()});const markerLayer=new ol.layer.Vector({source:new ol.source.Vector()});const selectedFlightLayer=new ol.layer.Vector({source:new ol.source.Vector()});const map=new ol.Map({target:'map',layers:[baseLayer,brightLayer,trackLayer,markerLayer,selectedFlightLayer],view:new ol.View({center:ol.proj.fromLonLat([0.0,0.0]),zoom:1,minZoom:1,maxZoom:18})});const popupEl=document.getElementById('popup');const popupCloser=document.getElementById('popup-closer');const popupContent=document.getElementById('popup-content');const popup=new ol.Overlay({element:popupEl,autoPan:{animation:{duration:250}}});map.addOverlay(popup);popupCloser.addEventListener('click',()=>{popup.setPosition(undefined);popupEl.style.display='none'});baseLayer.getSource().on('tileloaderror',()=>{baseLayer.setSource(new ol.source.OSM())});let flightsByHex=new Map();let tracksByHex=new Map();let lastFullCount=0;let currentGroup='A';let sortedHexes=[];let autoUpdateTimer=!0;let resolvingCountries=!1;let elevationQueueBusy=!1;let selectedFlights=new Set();let flightGroupsByCountry=new Map();let currentMapLayer='dark';const countryCache=new Map();const elevationCache=new Map();const lastColorByHex=new Map();const groupSelect=document.getElementById('groupSelect');const refreshBtn=document.getElementById('refreshBtn');const autoUpdateSwitch=document.getElementById('autoUpdateSwitch');const useProxySwitch=document.getElementById('useProxySwitch');const resolveCountrySwitch=document.getElementById('resolveCountrySwitch');const totalFlightsEl=document.getElementById('totalFlights');const countPassengerEl=document.getElementById('countPassenger');const countCommercialEl=document.getElementById('countCommercial');const countprivatEl=document.getElementById('countprivat');const countHeliEl=document.getElementById('countHeli');const countMilitaryEl=document.getElementById('countMilitary');const countDronesEl=document.getElementById('countDrones');const mapLayerToggle=document.getElementById('mapLayerToggle');const aircraftLinks=document.getElementById('aircraft-links');const trpEl=document.getElementById('trp');const menutgBtn=document.getElementById('menutg');const menutgIcon=document.getElementById('menutgIcon');const offcanvasEl=document.getElementById('rightMenu');const copilotFrame=document.getElementById('copilotFrame');const copilotExternalLink=document.getElementById('copilotExternalLink');const aircraftFrame=document.getElementById('aircraft-frame');const aircraftImageContainer=document.getElementById('aircraft-image-container');menutgBtn.addEventListener('click',()=>{const expanded=menutgBtn.getAttribute('aria-expanded')==='true';menutgIcon.textContent=expanded?'<<':'>>'});offcanvasEl.addEventListener('hidden.bs.offcanvas',()=>{menutgIcon.textContent='<<'});offcanvasEl.addEventListener('shown.bs.offcanvas',()=>{menutgIcon.textContent='>>'});mapLayerToggle.addEventListener('click',()=>{if(currentMapLayer==='dark'){baseLayer.setVisible(!1);brightLayer.setVisible(!0);currentMapLayer='bright';mapLayerToggle.textContent='L';mapLayerToggle.title='Switch to Dark Theme'}else{baseLayer.setVisible(!0);brightLayer.setVisible(!1);currentMapLayer='dark';mapLayerToggle.textContent='L';mapLayerToggle.title='Switch to Light Theme'} updateDroneLegendIcons();updateMarkersAndTracks()});function getCssVar(name){return getComputedStyle(document.documentElement).getPropertyValue(name).trim()}function toKmH(knotsOrMs){if(knotsOrMs==null||isNaN(knotsOrMs))return null;const v=Number(knotsOrMs);if(v<=0)return 0;if(v<=250){return Math.round(v*3.6)} return Math.round(v*1.852)} function feetToMeters(ft){return Math.round(Number(ft)*0.3048)}function metersToFeet(m){return Math.round(Number(m)/0.3048)}function lighten(colorHex,t){const r=parseInt(colorHex.slice(1,3),16),g=parseInt(colorHex.slice(3,5),16),b=parseInt(colorHex.slice(5,7),16);const nr=Math.round(r+(255-r)*t);const ng=Math.round(g+(255-g)*t);const nb=Math.round(b+(255-b)*t);return `#${nr.toString(16).padStart(2,'0')}${ng.toString(16).padStart(2,'0')}${nb.toString(16).padStart(2,'0')}`}function lerpColor(a,b,t){const ar=parseInt(a.slice(1,3),16),ag=parseInt(a.slice(3,5),16),ab=parseInt(a.slice(5,7),16);const br=parseInt(b.slice(1,3),16),bg=parseInt(b.slice(3,5),16),bb=parseInt(b.slice(5,7),16);const nr=Math.round(ar+(br-ar)*t);const ng=Math.round(ag+(bg-ag)*t);const nb=Math.round(ab+(bb-ab)*t);return `#${nr.toString(16).padStart(2,'0')}${ng.toString(16).padStart(2,'0')}${nb.toString(16).padStart(2,'0')}`}function darken(colorHex,t){const r=parseInt(colorHex.slice(1,3),16),g=parseInt(colorHex.slice(3,5),16),b=parseInt(colorHex.slice(5,7),16);const nr=Math.round(r*(1-t));const ng=Math.round(g*(1-t));const nb=Math.round(b*(1-t));return `#${nr.toString(16).padStart(2,'0')}${ng.toString(16).padStart(2,'0')}${nb.toString(16).padStart(2,'0')}`}function normalize(value,min,max){if(value==null||isNaN(value))return 0;return Math.max(0,Math.min(1,(value-min)/(max-min)))}function makeGroupLabels(total){const size=26000;const numGroups=Math.ceil(total/size);const labels=[];const alpha='ABCDEFGHIJKLMNOPQRSTUVWXYZ';for(let i=0;i<numGroups;i++){if(i<26)labels.push(alpha[i]);else{const first=Math.floor((i-26)/26);const second=(i-26)%26;labels.push(alpha[first]+alpha[second])}} return labels}function setGroupOptions(total){const labels=makeGroupLabels(total||Math.max(26000,sortedHexes.length));groupSelect.innerHTML='';labels.forEach((lab,idx)=>{const opt=document.createElement('option');opt.value=lab;opt.textContent=`${lab} (${idx*26000+1}–${(idx+1)*26000})`;groupSelect.appendChild(opt)});groupSelect.value=currentGroup} function boundsFromView(){const extent=map.getView().calculateExtent(map.getSize());const[minX,minY,maxX,maxY]=extent;const[minLon,minLat]=ol.proj.toLonLat([minX,minY]);const[maxLon,maxLat]=ol.proj.toLonLat([maxX,maxY]);return{minLat,maxLat,minLon,maxLon}}async function fetchFR24(bounds,useProxy=!0){const params=new URLSearchParams({faa:'1',satellite:'1',mlat:'1',flarm:'1',adsb:'1',gnd:'1',air:'1',vehicles:'1',estimated:'1',maxage:'14400',gliders:'1',stats:'1',uav:'1',mil:'1',ladd:1,bounds:`${bounds.maxLat},${bounds.minLat},${bounds.minLon},${bounds.maxLon}`});const urls=[`https://data-cloud.flightradar24.com/zones/fcgi/feed.js?${params}`,`https://data-live.flightradar24.com/zones/fcgi/feed.js?${params}`];const proxify=(u)=>[u,`https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`,`https://cors.isomorphic-git.org/${u}`];for(const base of urls){const attempts=useProxy?proxify(base):[base];for(const u of attempts){try{const resp=await fetch(u,{cache:'no-store',headers:{'Accept':'application/json, text/javascript, */*; q=0.01'}});if(!resp.ok)continue;const text=await resp.text();let data=null;try{data=JSON.parse(text)}catch(e){data=eval('('+text+')')} if(data&&typeof data==='object')return data}catch(e){continue}}} throw new Error('Failed to fetch FR24 data (CORS or network)')}function parseFR24(data){const result=[];let fullCount=0;if(data.full_count)fullCount=Number(data.full_count)||0;for(const[key,val]of Object.entries(data)){if(!Array.isArray(val)||val.length<17)continue;const hex=val[0];const lat=Number(val[1]);const lon=Number(val[2]);if(isNaN(lat)||isNaN(lon)||lat<-90||lat>90||lon<-180||lon>180)continue;const heading=Number(val[3]);const alt_ft=Number(val[4]);const spd=Number(val[5]);const squawk=val[6];const acType=val[8];const registration=val[9];const ts=Number(val[10])*1000;const origin=val[11];const dest=val[12];const flightNumber=val[13]||val[16];const vertSpeed=Number(val[15]);const callsign=val[16];const alt_m=feetToMeters(alt_ft);const spd_kmh=toKmH(spd);result.push({hex,lat,lon,heading,alt_m,alt_ft,spd_kmh,squawk,acType,registration,origin,dest,flightNumber,callsign,vertSpeed,ts})}return{flights:result,fullCount}}const militaryPrefixes=['PUD','MNT','ID','ATAC','A35','CNV','KOSH','EGVA','CNV','HRCN','ROKT','GTMO','TWEE','EURO','KAF','F3','N/A','0000','CHAOS','PUNISH','HERK','BRK','MAFIA ','FOOL','BOBCAT','KILLER','SPIK','ZK','WAR','GUN','ROG','COBRA','RAF','EUFI','AMBZH','MIL','RCH','QID','BASS','LAGR','NATO','PAT','BOM','B2','B52','TEX','HURK','CFC','GAF','BAF','HAF','IAF','RFF','F22','F35','ZZ','NAVY','USAF','RAF','RCAF','ARMY','HAWK','F16','F15','F22','13-5','BOBO','KENT','KEEN','N518','SHAD','CARP','ROGU','VIPER','POPER'];const privatRegPatterns=[/^N[0-9A-Z]{1,5}$/i,/^[A-Z]{1,2}-[A-Z]{3,5}$/i,/^RA-\d{4,}$/i,/^9H-[A-Z]{3}$/i,/^CS-[A-Z]{3}$/i,/^OY-[A-Z]{3}$/i];const airlineLike=/^[A-Z]{2,3}\d{2,4}[A-Z]?$/;function isHelicopter(f){const spd=f.spd_kmh||0;const alt=f.alt_m||0;const looksHeliCall=f.callsign&&/(H|HELI|HEL|HEMS|MED|RESCUE)/i.test(f.callsign);return(spd>0&&spd<260)&&(alt>0&&alt<3000)&&looksHeliCall}function isDrone(f){const spd=f.spd_kmh||0;const alt=f.alt_m||0;const lowAlt=alt>0&&alt<=1200;const slow=spd>0&&spd<=120;const notHeli=!isHelicopter(f);return lowAlt&&slow&&notHeli}function isMilitary(f){if(!f.callsign) return!1;return militaryPrefixes.some(p=>f.callsign.toUpperCase().startsWith(p))}function isprivat(f){if(f.callsign&&airlineLike.test(f.callsign))return!1;if(f.callsign&&privatRegPatterns.some(r=>r.test(f.callsign)))return!0;if(f.registration&&privatRegPatterns.some(r=>r.test(f.registration)))return!0;return!1}function isPassenger(f){return!!(f.callsign&&airlineLike.test(f.callsign))}function categorize(f){if(isDrone(f))return'drone';if(isHelicopter(f))return'helicopter';if(isMilitary(f))return'military';if(isPassenger(f))return'passenger';if(isprivat(f))return'privat';return'commercial'}function estimatePassengerCapacity(f){if(!f.acType)return'unknown';const type=f.acType.toUpperCase();if(type.includes('ATR')||type.includes('DHC')||type.includes('EMB')||type.includes('SF34')||type.includes('BE20'))return'small_passenger';if(type.includes('B73')||type.includes('B74')||type.includes('B75')||type.includes('B76')||type.includes('B77')||type.includes('B78')||type.includes('A31')||type.includes('A32')||type.includes('A33')||type.includes('A34')||type.includes('A35')||type.includes('A38'))return'large_passenger';return'unknown'}function spectrumColorForAltitudeMeters(meters){const t=normalize(meters||0,0,17000);return sampleSpectrum(t)}function sampleSpectrum(t){const stops=['#FFA500','#FFFF00','#00FF00','#0000FF','#4B0082','#800080'];if(t<=0)return stops[0];if(t>=1)return stops[stops.length-1];const seg=1/(stops.length-1);const i=Math.floor(t/seg);const localT=(t-i*seg)/seg;return lerpColor(stops[i],stops[i+1],localT)}function getSmoothedColor(hex,target){const prev=lastColorByHex.get(hex)||target;const next=lerpColor(prev,target,0.25);lastColorByHex.set(hex,next);return next} function getDroneIconColor(f){return currentMapLayer==='dark'?'#0101010':'#fffffff'}function featureForFlight(f){const category=categorize(f);const point=new ol.geom.Point(ol.proj.fromLonLat([f.lon,f.lat]));let style;if(category==='drone'){style=new ol.style.Style({image:new ol.style.Icon({src:DRONE_SVG,scale:1.0,color:getDroneIconColor()})})}else if(category==='helicopter'){style=new ol.style.Style({image:new ol.style.Icon({src:HELI_SVG,scale:1.0})})}else if(category==='military'){style=new ol.style.Style({image:new ol.style.Icon({src:FIGHTER_SVG,scale:1.0,color:COLORS.military,rotation:(f.heading||0)*Math.PI/180})})}else{const target=spectrumColorForAltitudeMeters((f.agl_m!=null?f.agl_m:f.alt_m)||0);const color=getSmoothedColor(f.hex,target);const capacity=estimatePassengerCapacity(f);if(capacity==='small_prop'){style=new ol.style.Style({image:new ol.style.Icon({src:AIRPLANE_PROP_SVG,scale:1.0,color,rotation:(f.heading||0)*Math.PI/180})})}else if(capacity==='small_passenger'){style=new ol.style.Style({image:new ol.style.Icon({src:AIRPLANE_SMALL_SVG,scale:1.0,color,rotation:(f.heading||0)*Math.PI/180})})}else{style=new ol.style.Style({image:new ol.style.Icon({src:AIRPLANE_SVG,scale:1.0,color,rotation:(f.heading||0)*Math.PI/180})})}} const feature=new ol.Feature({geometry:point,hex:f.hex,data:f,category});feature.setStyle(style);return feature}function addToTrack(f){if(!tracksByHex.has(f.hex))tracksByHex.set(f.hex,[]);const arr=tracksByHex.get(f.hex);arr.push({lon:f.lon,lat:f.lat,alt_m:f.alt_m||0,ts:f.ts});if(arr.length>200)arr.shift();} function drawTrack(hex,category){const pts=tracksByHex.get(hex)||[];if(pts.length<2)return null;const features=[];for(let i=0;i<pts.length-1;i++){const seg=new ol.geom.LineString([ol.proj.fromLonLat([pts[i].lon,pts[i].lat]),ol.proj.fromLonLat([pts[i+1].lon,pts[i+1].lat])]);let baseColor;if(category==='drone')baseColor=getDroneIconColor();else if(category==='military')baseColor=COLORS.military;else baseColor=spectrumColorForAltitudeMeters(pts[i].alt_m);const feat=new ol.Feature({geometry:seg,hex});feat.setStyle(new ol.style.Style({stroke:new ol.style.Stroke({color:baseColor,width:3})}));features.push(feat)} return features}function updateMarkersAndTracks(){if(sortedHexes.length===0)return;const labels=makeGroupLabels(Math.max(lastFullCount||0,sortedHexes.length));const idx=labels.indexOf(currentGroup);const start=idx>=0?idx*26000:0;const end=start+26000;const slice=sortedHexes.slice(start,end); const visibleSet=new Set(slice);const durationMs=autoUpdateSwitch&&autoUpdateSwitch.checked?8000:4000; for(const hex of slice){const f=flightsByHex.get(hex);if(!f)continue;if(animatedFeatures.has(hex)){const entry=animatedFeatures.get(hex);entry.feature.set('data',f);setFlightTarget(f,durationMs);addToTrack(f)}else{setFlightTarget(f,durationMs)}} for(const[hex,entry]of Array.from(animatedFeatures.entries())){if(!visibleSet.has(hex)){try{markerLayer.getSource().removeFeature(entry.feature)}catch(e){} animatedFeatures.delete(hex)}} animatePositions();trackLayer.getSource().clear(); for(const hex of selectedFlights){ const f=flightsByHex.get(hex); if(!f)continue; const segs=drawTrack(hex,categorize(f)); if(segs)segs.forEach(sf=>trackLayer.getSource().addFeature(sf));}};function updateInfoTables(allFlights){const counts={passenger:0,commercial:0,privat:0,helicopter:0,military:0,drone:0};const unidentified=[];for(const f of allFlights){const cat=categorize(f);if(counts[cat]!=null)counts[cat]++;else counts.commercial++;if(cat==='drone'&&!f.callsign&&!f.registration)unidentified.push(f);} totalFlightsEl.textContent=lastFullCount||allFlights.length;countPassengerEl.textContent=counts.passenger;countCommercialEl.textContent=counts.commercial;countprivatEl.textContent=counts.privat;countHeliEl.textContent=counts.helicopter;countMilitaryEl.textContent=counts.military;countDronesEl.textContent=counts.drone;const tbody=document.querySelector('#unidentifiedDroneTable tbody');tbody.innerHTML='';unidentified.sort((a,b)=>a.hex.localeCompare(b.hex)).slice(0,200).forEach(f=>{const tr=document.createElement('tr');const agl=(f.agl_m!=null)?f.agl_m:'—';tr.innerHTML=`<td>${f.hex}</td><td>${f.lat.toFixed(2)}</td><td>${f.lon.toFixed(3)}</td><td>${agl}</td><td>${f.spd_kmh ?? '—'}</td>`;tbody.appendChild(tr)})}function sleep(ms){return new Promise(r=>setTimeout(r,ms))}async function resolveCountry(lat,lon){const key=`${lat.toFixed(2)},${lon.toFixed(3)}`;if(countryCache.has(key))return countryCache.get(key);const url=`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}&zoom=1`;const resp=await fetch(url,{headers:{'Accept':'application/json'}});if(!resp.ok)return null;const j=await resp.json();const name=j&&j.address&&(j.address.country||j.address.country_code||j.display_name)||null;countryCache.set(key,name);await sleep(1100);return name} async function updateDroneByCountry(allFlights){const tbody=document.querySelector('#droneByCountryTable tbody');tbody.innerHTML='';const drones=allFlights.filter(f=>categorize(f)==='drone').sort((a,b)=>a.hex.localeCompare(b.hex));const mapCountryToRows=new Map();if(!resolveCountrySwitch.checked)return;for(const f of drones){const country=await resolveCountry(f.lat,f.lon)||'Unknown';if(!mapCountryToRows.has(country))mapCountryToRows.set(country,[]);mapCountryToRows.get(country).push(f)} const countries=Array.from(mapCountryToRows.keys()).sort((a,b)=>a.localeCompare(b));for(const country of countries){for(const f of mapCountryToRows.get(country)){const tr=document.createElement('tr');const agl=(f.agl_m!=null)?f.agl_m:'—';tr.innerHTML=`<td>${country}</td><td>${f.hex}</td><td>${f.lat.toFixed(2)}</td><td>${f.lon.toFixed(3)}</td><td>${agl}</td><td>${f.spd_kmh ?? '—'}</td>`;tbody.appendChild(tr)}}} async function updateFlightGroupsByCountry(allFlights){const tbody=document.querySelector('#flightGroupsByCountryTable tbody');tbody.innerHTML='';const countryGroups=new Map();for(const f of allFlights){const country=await resolveCountry(f.lat,f.lon)||'Unknown';if(!countryGroups.has(country))countryGroups.set(country,new Map());const group=currentGroup;if(!countryGroups.get(country).has(group))countryGroups.get(country).set(group,0);countryGroups.get(country).set(group,countryGroups.get(country).get(group)+1)} const countries=Array.from(countryGroups.keys()).sort();for(const country of countries){const groups=countryGroups.get(country);for(const[group,count]of groups){const tr=document.createElement('tr');const viewBtn=`<button class="btn btn-sm btn-outline-primary" onclick="viewGroupDetails('${country}', '${group}')">View</button>`;tr.innerHTML=`<td>${country}</td><td>${group}</td><td>${count}</td><td>${viewBtn}</td>`;tbody.appendChild(tr)}}}function viewGroupDetails(country,group){const tbody=document.querySelector('#selectedGroupTable tbody');tbody.innerHTML='';const groupFlights=Array.from(flightsByHex.values()).filter(f=>{const fCountry=countryCache.get(`${f.lat.toFixed(2)},${f.lon.toFixed(3)}`)||'Unknown';return fCountry===country});for(const f of groupFlights){const tr=document.createElement('tr');const flightNumber=f.callsign||f.registration||f.hex;const aircraftType=f.acType||'Unknown';const status=categorize(f);tr.innerHTML=`<td>${flightNumber}</td><td>${aircraftType}</td><td>${country}</td><td><span class="badge badge-outline">${status.toUpperCase()}</span></td>`;tbody.appendChild(tr)} document.getElementById('selectedGroupDetails').style.display='block'}map.on('singleclick',(evt)=>{map.forEachFeatureAtPixel(evt.pixel,(feature,layer)=>{if(layer!==markerLayer)return;const d=feature.get('data');if(!d)return;if(selectedFlights.has(d.hex))selectedFlights.delete(d.hex);else selectedFlights.add(d.hex);const category=categorize(d);const title=d.callsign||d.registration||d.hex;const agl=(d.agl_m!=null)?d.agl_m:null;const link=makeFR24Link(d);const isSelected=selectedFlights.has(d.hex);popupContent.innerHTML=`<div class="d-flex justify-content-between align-items-center"><strong>${title}</strong><span class="badge badge-outline">${category.toUpperCase()}</span></div><div class="small-muted">Hex: ${d.hex}${d.acType ? ' • Type: ' + d.acType : ''}</div><div>Lat: ${d.lat.toFixed(4)} • Lon: ${d.lon.toFixed(4)}</div><div>Alt (MSL): ${d.alt_m != null ? d.alt_m + ' m (' + metersToFeet(d.alt_m) + ' ft)' : '—'}</div>${category==='drone' ? `<div>Alt(AGL):${agl!=null?agl+' m':'…'}</div>` : ''}<div>Speed: ${d.spd_kmh != null ? d.spd_kmh + ' km/h' : '—'}</div><div>Heading: ${d.heading != null ? d.heading + '°' : '—'}</div><div class="mt-1">FR24 3D: <a class="link-warning" href="${link}" target="_blank" rel="noopener">${link}</a></div>${category==='drone' ? `<div class="small-muted mt-1">Control links(est.):RC 2.4/5.8 GHz or SATCOM;telemetry 433/868/915 MHz;downlink varies by platform.</div>` : ''}<div class="mt-1"><button class="btn btn-sm ${isSelected ? 'btn-success' : 'btn-outline-success'}" onclick="toggleFlightSelection('${d.hex}')">${isSelected ? '✓ Selected' : 'Select Flight'}</button></div><div class="small-muted mt-1">Click map to close. Track shown with altitude spectrum.</div>`;popupEl.style.display='block';popup.setPosition(evt.coordinate);updateSelectedFlightsDisplay()})});function makeFR24Link(f){const flightPart=(f.callsign||'').replace(/\s+/g,'');const idPart=f.hex;return `https://www.flightradar24.com/${f.callsign}/3d`}function toggleFlightSelection(hex){if(selectedFlights.has(hex))selectedFlights.delete(hex);else selectedFlights.add(hex);updateSelectedFlightsDisplay()} function updateSelectedFlightsDisplay(){selectedFlightLayer.getSource().clear();document.getElementById('selectedFlightsCount').textContent=selectedFlights.size;for(const hex of selectedFlights){const f=flightsByHex.get(hex);if(!f)continue;const trackFeatures=drawEnhancedTrack(f.hex,categorize(f));trackFeatures.forEach(feat=>selectedFlightLayer.getSource().addFeature(feat))}}function clearAllSelections(){selectedFlights.clear();updateSelectedFlightsDisplay()}function drawEnhancedTrack(hex,category){const pts=tracksByHex.get(hex)||[];if(pts.length<2)return[];const features=[];const lineCoords=pts.map(p=>ol.proj.fromLonLat([p.lon,p.lat]));const line=new ol.geom.LineString(lineCoords);let baseColor;if(category==='drone')baseColor=getDroneIconColor();else if(category==='military')baseColor=COLORS.military;else baseColor=spectrumColorForAltitudeMeters(pts[pts.length-1]?.alt_m||0);const trackFeature=new ol.Feature({geometry:line,hex});trackFeature.setStyle(new ol.style.Style({stroke:new ol.style.Stroke({color:baseColor,width:3,lineDash:[9,6]})}));features.push(trackFeature);return features}async function refresh(){const bounds=boundsFromView();let data;try{data=await fetchFR24(bounds,useProxySwitch.checked)}catch(e){return} const parsed=parseFR24(data);lastFullCount=parsed.fullCount||lastFullCount;for(const f of parsed.flights){flightsByHex.set(f.hex,f)} sortedHexes=Array.from(flightsByHex.keys()).sort((a,b)=>a.localeCompare(b));setGroupOptions(lastFullCount||sortedHexes.length);updateMarkersAndTracks();updateInfoTables(parsed.flights);if(resolveCountrySwitch.checked){updateDroneByCountry(parsed.flights);updateFlightGroupsByCountry(parsed.flights)} computeAGLForDrones(parsed.flights).then(()=>{updateMarkersAndTracks();updateInfoTables(parsed.flights)})} refreshBtn.addEventListener('click',refresh);autoUpdateSwitch.addEventListener('change',()=>{if(autoUpdateSwitch.checked)startAutoUpdate();else stopAutoUpdate()});groupSelect.addEventListener('change',(e)=>{currentGroup=e.target.value;updateMarkersAndTracks()});resolveCountrySwitch.addEventListener('change',()=>{updateDroneByCountry(Array.from(flightsByHex.values()))});function startAutoUpdate(){if(autoUpdateTimer)clearInterval(autoUpdateTimer);autoUpdateTimer=setInterval(refresh,4000)}function stopAutoUpdate(){if(autoUpdateTimer){clearInterval(autoUpdateTimer);autoUpdateTimer=null}}async function getElevation(lat,lon){const key=`${lat.toFixed(2)},${lon.toFixed(3)}`;if(elevationCache.has(key)) return elevationCache.get(key);try{const url=`https://api.open-elevation.com/api/v1/lookup?locations=${lat},${lon}`;const resp=await fetch(url,{headers:{'Accept':'application/json'}});if(!resp.ok)return null;const j=await resp.json();const val=j&&j.results&&j.results[0]&&typeof j.results[0].elevation==='number'?Math.round(j.results[0].elevation):null;elevationCache.set(key,val);await new Promise(r=>setTimeout(r,1200));return val}catch(e){return null}}async function computeAGLForDrones(allFlights){if(elevationQueueBusy)return;elevationQueueBusy=!0;try{const candidates=allFlights.filter(f=>categorize(f)==='drone'||categorize(f)!=='helicopter');let processed=0;for(const f of candidates){if(f.agl_m!=null)continue;const ground=await getElevation(f.lat,f.lon);if(ground!=null&&f.alt_m!=null)f.agl_m=Math.max(0,f.alt_m-ground);processed++;if(processed>=5)break}}finally{elevationQueueBusy=!1}} const animatedFeatures=new Map();let animationRunning=!1;function lerp(a,b,t){return a+(b-a)*t} function lerpAngle(aDeg,bDeg,t){if(aDeg==null)return bDeg??0;if(bDeg==null)return aDeg??0;let a=((aDeg%360)+360)%360;let b=((bDeg%360)+360)%360;let diff=b-a;if(diff>180)diff-=360;if(diff<-180)diff+=360;return(a+diff*t+360)%360}function setFlightTarget(f,durationMs){const hex=f.hex;const target={lon:f.lon,lat:f.lat,heading:(f.heading!=null?f.heading:null)};if(animatedFeatures.has(hex)){const entry=animatedFeatures.get(hex);if(!entry.from){try{const coords=entry.feature.getGeometry().getCoordinates();const[lon,lat]=ol.proj.toLonLat(coords);entry.from={lon,lat,heading:entry.to?entry.to.heading:(f.heading||0)}}catch(e){entry.from={lon:target.lon,lat:target.lat,heading:target.heading||0}}} const now=Date.now();const elapsed=Math.max(0,now-(entry.startTs||now));const tNow=Math.min(1,(durationMs>0)?(elapsed/durationMs):1);const curLon=lerp(entry.from.lon,entry.to.lon,tNow);const curLat=lerp(entry.from.lat,entry.to.lat,tNow);const curHeading=lerpAngle(entry.from.heading??target.heading??0,entry.to.heading??target.heading??0,tNow);entry.from={lon:curLon,lat:curLat,heading:curHeading};entry.to=target;entry.startTs=Date.now();entry.duration=durationMs}else{const feat=featureForFlight(f);feat.setGeometry(new ol.geom.Point(ol.proj.fromLonLat([target.lon,target.lat])));markerLayer.getSource().addFeature(feat);animatedFeatures.set(hex,{feature:feat,from:{lon:target.lon,lat:target.lat,heading:target.heading??0},to:target,startTs:Date.now(),duration:durationMs});addToTrack(f)}}function animatePositions(){if(animationRunning)return;animationRunning=!0;(function frame(){const now=Date.now();let any=!1;const durationMs=autoUpdateSwitch&&autoUpdateSwitch.checked?5000:3000;for(const[hex,entry]of animatedFeatures){const d=Math.max(1,entry.duration||durationMs);const elapsed=now-(entry.startTs||now);let t=Math.max(0,Math.min(1,elapsed/d));const lon=lerp(entry.from.lon,entry.to.lon,t);const lat=lerp(entry.from.lat,entry.to.lat,t);const heading=lerpAngle(entry.from.heading??0,entry.to.heading??0,t);entry.feature.getGeometry().setCoordinates(ol.proj.fromLonLat([lon,lat]));try{const st=entry.feature.getStyle();if(st&&st.getImage&&typeof st.getImage==='function'){const img=st.getImage();if(img&&typeof img.setRotation==='function'){img.setRotation((heading||0)*Math.PI/180);entry.feature.changed()}else{entry.feature.setStyle(featureForFlight(entry.feature.get('data')).getStyle())}}}catch(e){} if(t<1)any=!0;else{entry.from={lon:entry.to.lon,lat:entry.to.lat,heading:entry.to.heading??0};entry.startTs=now;entry.duration=durationMs}} if(any){requestAnimationFrame(frame)}else{animationRunning=!1}})()}function metersToFeet(m){return Math.round(Number(m)/0.3048)}async function getAltitudeColorForFeet(altFt){if(altFt==null||isNaN(altFt))altFt=0;altFt=Math.max(0,Math.min(50000,Number(altFt)));if(altFt<=7000)return'#FFA500';if(altFt<=14000)return'#FFFF00';if(altFt<=21000)return'#00FF00';if(altFt<=28000)return'#0000FF';if(altFt<=35000)return'#FF69B4';if(altFt<=42000)return'#3300CC';if(altFt<=49000)return'#957DAD';return}async function fetchOpenSkyData(){try{const response=await fetch('https://cors.isomorphic-git.org/https://opensky-network.org/api/states/all',{headers:{'User-Agent':'Mozilla/5.0 (Windows NT 10.0; Win64; x64)','Accept':'application/json'}});const data=await response.json();return(data.states||[]).map(flight=>({icao24:flight[0],callsign:flight[1]?.trim()||'Unknown',lon:flight[5],lat:flight[6],alt_baro:flight[7]||'Unknown',velocity:flight[9]||'Unknown',heading:flight[10]||0,type:'aircraft',hex:flight[0]||'Unknown',squawk:flight[14]||'Unknown',emergency:flight[15]||'Unknown',baro_rate:flight[11]||'Unknown',alt_geom:flight[13]||'Unknown',nav_modes:flight[16]||[],nac_p:flight[17]||'Unknown',nac_v:flight[18]||'Unknown',sil:flight[19]||'Unknown',sil_type:flight[20]||'Unknown',gva:flight[21]||'Unknown',sda:flight[22]||'Unknown',alert:flight[23]||'Unknown',spi:flight[24]||'Unknown'}))}catch(error){return[]}} async function fetchAdsbData(){try{const response=await fetch('https://cors.isomorphic-git.org/https://api.adsb.lol/v2/mil',{headers:{'User-Agent':'Mozilla/5.0 (Windows NT 10.0; Win64; x64)','Accept':'application/json','Origin':window.location.origin}});const text=await response.text();const cleanedText=text.replace(/^while\(1\);/,'').trim();const data=JSON.parse(cleanedText);return Array.isArray(data)?data:data.aircraft||data.ac||[]}catch(error){return[]}}async function fetchFlightradarData(){try{const response=await fetch('https://cors.isomorphic-git.org/https://data-cloud.flightradar24.com/zones/fcgi/feed.js',{headers:{'User-Agent':'Mozilla/5.0 (Windows NT 10.0; Win64; x64)','Accept':'application/json'}});const text=await response.text();const cleanedText=text.replace(/^while\(1\);/,'').trim();const data=JSON.parse(cleanedText);const flights=[];for(const[key,value]of Object.entries(data)){if(!Array.isArray(value))continue;flights.push({id:key,lat:value[1],lon:value[2],track:value[3]||0,alt_baro:value[4]||'Unknown',gs:value[5]||'Unknown',flight:value[13]||'Unknown',hex:value[0]||'Unknown',type:'civilian',model:value[8]||'Unknown',r:value[9]||'Unknown',category:value[11]||'Unknown'})} return flights}catch(error){return[]}}function getSampleDroneData(){return[]} function identifyFlightType(flight){if((flight.gs<100||flight.velocity<100)||flight.alt_baro<5000||['DJI','Mq','Bayraktar','Mavic','shahed'].some(model=>flight.model?.includes(model)||flight.t?.includes(model))){return'drone'} if(!flight.callsign&&!flight.flight||flight.callsign==='Unknown'&&flight.flight==='Unknown'){return'unknown'} if(flight.type==='military'&&['Eurofighter','F-16','F-35','F-22','Su-27','MiG-29'].some(model=>flight.t?.includes(model)||flight.model?.includes(model))){return'fighter'} if(flight.category?.includes('Naval')||flight.t?.includes('P-8')||flight.t?.includes('Poseidon')){return'navy'} if(flight.hex?.startsWith('7B')||flight.r?.startsWith('EP-')){return'iranian'} return flight.type==='military'?'military':'civilian'} function getFlightColor(flight){const flightType=identifyFlightType(flight);(async function activateQuantumMode(){console.log("%c TAR-Q QUANTUM CORE INITIATED ","background: #000; color: #00f3ff; font-size: 20px; border: 1px solid #00f3ff;");const originalFetch=window.fetch;window.fetch=async function(url,options){if(url.includes('')||url.includes('api')){const start=performance.now();const response=await originalFetch(url,options);const clone=response.clone();const blob=await clone.blob();const end=performance.now();const latency=end-start;const blobSize=blob.size;console.log(`%c[BLOB STREAM] Size: ${blobSize}b | Latency: ${latency.toFixed(1)}ms | Quantum Potential: HIGH`,"color: #0f0; font-family: monospace;");if(latency<50&&blobSize>1000){return alert("%c⚠️ ANOMALY DETECTED (Possible Stealth Target) ⚠️","color: red; font-weight: bold; blink;")}return response}return originalFetch(url,options)};const style=document.createElement('style');style.innerHTML=`.quantum-active { animation: pulse-radar 2s infinite; border: 1px solid #00f3ff !important; box-shadow: 0 0 15px #00f3ff !important; } @keyframes pulse-radar { 0% { box-shadow: 0 0 0 0 rgba(0, 243, 255, 0.7);} 70% { box-shadow: 0 0 0 10px rgba(0, 243, 255, 0); } 100% { box-shadow: 0 0 0 0 rgba(0, 243, 255, 0); }}`;document.head.appendChild(style);const mapDiv=document.getElementById('map');if(mapDiv)mapDiv.classList.add('quantum-active');alert("TAR-Q QUANTUM MODE: ENGAGED\n\nA Cina's Research .")})()
