<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=0.9" />
  <title>TAR-Q / index</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v8.2.0/ol.css" />
  <style>
    html,body {height:100%;margin:0;background:#0b0f14}
    #inner-frame {position:fixed;inset:0;width:100vw;height:100vh;border:none;z-index:0;}
    #enhancements-host {position: fixed; right:56px; top:6px; z-index:1400; display:flex; gap:8px;}
    .enh-btn {background:rgba(0,0,0,.5);color:#ffd400;border:1px solid #26333a;padding:7px 12px;border-radius:6px;font-size:14px}
    #enh-help{position:fixed;left:14px;top:10px;z-index:1440;color:#ffd400;font-size:13px;background:rgba(0,0,0,0.31);padding:6px 13px;border-radius:10px}
    #attribution{position:fixed;left:8px;bottom:8px;color:#9aa2aa;font-size:13px;z-index:1200}
  </style>
</head>
<body>
  <button id="menuToggle" class="btn btn-sm" style="position:fixed;top:6px;left:12px;z-index:1400;">☰</button>
  <button id="mapLayerToggle" class="enh-btn" style="position:fixed;top:6px;left:56px;z-index:1400;">L</button>
  <button id="copilotToggle" class="enh-btn" style="position:fixed;top:6px;left:110px;z-index:1400;">㉿</button>
  <div id="attribution">© ArcGIS | OpenStreetMap</div>

  <div id="enhancements-host">
    <button id="perfToggle" class="enh-btn">Perf: <span id="perfMode">Auto</span></button>
    <button id="onlySusp" class="enh-btn">Only Suspicious</button>
    <button id="copyDebug" class="enh-btn">Copy Debug</button>
  </div>

  <div id="enh-help">Press K to open Copilot (radar panel). Esc to close.</div>

  <!-- original app embedded unchanged -->
  <iframe id="inner-frame" src="tar-q.html" title="TAR-Q application (embedded)"></iframe>

  <!-- Copilot offcanvas (parent-level) -->
  <div class="offcanvas offcanvas-start" tabindex="-1" id="copilotPanel" aria-labelledby="copilotLabel">
    <div class="offcanvas-header">
      <h5 id="copilotLabel">Copilot — Quantum Blob</h5>
      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body p-0" style="height:calc(80vh - 56px); display:flex; flex-direction:column;">
      <iframe id="copilotFrame" src="" style="flex:1; border:0; width:100%; background:#000" title="Copilot Panel (Quantum Blob)"></iframe>
      <div class="p-2 small-muted" style="background: linear-gradient(to top,rgba(0,0,0,.65),transparent);">If the Copilot UI fails to load, <a id="copilotExternalLink" class="link-warning" href="#" target="_blank" rel="noopener">Open</a></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ol@v8.2.0/dist/ol.js"></script>

  <script>
    (function () {
      const frame = document.getElementById('inner-frame');
      const perfToggle = document.getElementById('perfToggle');
      const perfModeLabel = document.getElementById('perfMode');
      const onlySuspBtn = document.getElementById('onlySusp');
      const copyDebugBtn = document.getElementById('copyDebug');
      const copilotToggleBtn = document.getElementById('copilotToggle');
      const copilotFrame = document.getElementById('copilotFrame');
      const copilotPanelEl = document.getElementById('copilotPanel');
      const copilotExternalLink = document.getElementById('copilotExternalLink');
      const bsCopilot = new bootstrap.Offcanvas(copilotPanelEl);

      let perfMode = 'auto';
      let onlySuspicious = false;

      function postToApp(type, payload = {}) {
        try { frame.contentWindow.postMessage({ __tarq_cmd: true, type, payload }, '*'); } catch (e) {}
      }

      perfToggle.addEventListener('click', () => {
        perfMode = perfMode === 'auto' ? 'low' : (perfMode === 'low' ? 'high' : 'auto');
        perfModeLabel.innerText = perfMode;
        postToApp('setPerfMode', { mode: perfMode });
      });

      onlySuspBtn.addEventListener('click', () => {
        onlySuspicious = !onlySuspicious;
        onlySuspBtn.style.background = onlySuspicious ? 'rgba(255, 0, 60, 0.12)' : '';
        postToApp('onlySuspicious', { enabled: onlySuspicious });
      });

      copyDebugBtn.addEventListener('click', () => {
        postToApp('requestDebugSnapshot', {});
        copyDebugBtn.innerText = 'Requested…';
        setTimeout(() => copyDebugBtn.innerText = 'Copy Debug', 1000);
      });

      const COPILOT_HTML = `<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>Cinascorp Quantum Blob Analyzer</title><script src="https://cdn.tailwindcss.com"></script><style>@import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&display=swap');body{margin:0;background:#000510;color:#00f3ff;font-family:Rajdhani,system-ui,monospace;overflow:hidden}.radar-grid{background-image:radial-gradient(circle,rgba(0,243,255,0.08)1px,transparent 1px),radial-gradient(circle,rgba(0,243,255,0.06)1px,transparent 1px);background-size:50px 50px;background-position:0 0,25px 25px}.scan-line{position:absolute;top:50%;left:50%;width:50%;height:2px;background:linear-gradient(90deg,transparent 0%,rgba(0,243,255,0.8)100%);transform-origin:0% 0%;animation:radar-spin 4s linear infinite;box-shadow:0 0 15px #00f3ff}@keyframes radar-spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}.quantum-noise{position:absolute;inset:0;opacity:0.05;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");pointer-events:none}.data-stream{font-family:Courier,monospace;font-size:10px;line-height:10px;white-space:pre-wrap;word-break:break-all;opacity:0.7}.footer-panel{position:absolute;bottom:24px;left:12px;background:rgba(0,0,0,0.56);backdrop-filter:blur(4px);padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03)}</style></head><body><div class="quantum-noise"></div><div style="position:absolute;top:12px;left:12px;z-index:30"><div style="font-weight:700;color:#00f3ff;font-size:20px">CINASCORP</div><div style="font-size:11px;color:rgba(255,255,255,0.6)">QUANTUM BLOB DECODER // V.3.14</div></div><div class="radar-grid" style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center"><div style="position:relative;width:86%;height:86%;display:block"><div style="position:absolute;inset:0;border-radius:9999px;border:1px solid rgba(0,255,255,0.05)"></div><div class="scan-line"></div><div id="radar-screen" style="position:absolute;inset:0"></div><div class="footer-panel"><div>ENTANGLEMENT: <span style="color:#7ee0ff">99.8%</span></div><div>COHERENCE: <span style="color:#7ee0ff">STABLE</span></div><div>STEALTH TARGETS: <span id="stealth-count" style="color:#ff5566;font-weight:700">0</span></div></div></div></div><script>const radarScreen=document.getElementById('radar-screen');const stealthCounter=document.getElementById('stealth-count');let stealthCount=0;function generateHex(){const c='0123456789ABCDEF';let s='';for(let i=0;i<64;i++){s+=c[Math.floor(Math.random()*16)];if(i%2===1)s+=' ';}return s;}const hexView=document.createElement('div');hexView.style.position='absolute';hexView.style.right='8px';hexView.style.top='44px';hexView.style.width='220px';hexView.style.maxHeight='50%';hexView.style.overflow='auto';hexView.style.fontFamily='Courier,monospace';hexView.style.fontSize='10px';hexView.style.color='rgba(0,255,255,0.65)';hexView.style.background='rgba(0,0,0,0.31)';hexView.style.padding='7px';hexView.style.borderRadius='5px';document.body.appendChild(hexView);setInterval(()=>{const d=new Date();const t=('00'+d.getSeconds()).slice(-2)+'.'+('000'+d.getMilliseconds()).slice(-3);const line=document.createElement('div');line.textContent='['+t+'] '+generateHex();hexView.prepend(line);if(hexView.children.length>88)hexView.removeChild(hexView.lastChild);},76);function processQuantumBlob(){const isStealth=Math.random()>0.88;const angle=Math.random()*Math.PI*2;const distance=Math.random()*40+5;const blip=document.createElement('div');blip.style.position='absolute';blip.style.width='5px';blip.style.height='5px';blip.style.borderRadius='9999px';blip.style.transform='translate(-50%,-50%)';blip.style.left=(50+Math.cos(angle)*distance)+'%';blip.style.top=(50+Math.sin(angle)*distance)+'%';if(isStealth){blip.style.background='#ff003c';blip.style.boxShadow='0 0 11px #ff003c';stealthCount++;stealthCounter.textContent=stealthCount;const ring=document.createElement('div');ring.style.position='absolute';ring.style.left=blip.style.left;ring.style.top=blip.style.top;ring.style.width='15px';ring.style.height='15px';ring.style.border='2px solid rgba(255,0,60,0.5)';ring.style.borderRadius='9999px';ring.style.animation='ping 1s ease-out';radarScreen.appendChild(ring);setTimeout(()=>ring.remove(),900);}else{blip.style.background='#00f3ff';blip.style.boxShadow='0 0 5px #00f3ff';}radarScreen.appendChild(blip);setTimeout(()=>{blip.style.opacity='0';setTimeout(()=>blip.remove(),1100);},85);}setInterval(processQuantumBlob,110);setInterval(()=>{for(let i=0;i<7;i++)setTimeout(processQuantumBlob,i*24)},3900);const s=document.createElement('style');s.textContent='@keyframes ping{0%{transform:scale(0.9);opacity:0.7}65%{transform:scale(1.45);opacity:0.14}100%{opacity:0}}';document.head.appendChild(s);</script></body></html>`;

      postToApp('setPerfMode', { mode: perfMode });

      copilotPanelEl.addEventListener('shown.bs.offcanvas', () => {
        if (!copilotFrame.srcdoc) {
          copilotFrame.srcdoc = COPILOT_HTML;
          copilotExternalLink.href = 'data:text/html;charset=utf-8,' + encodeURIComponent(COPILOT_HTML);
          copilotFrame.addEventListener('load',() => {try{copilotFrame.contentWindow.focus();}catch(e){} });
        }
      });

      window.addEventListener('keydown', (ev) => {
        const tag = (ev.target && ev.target.tagName) ? ev.target.tagName.toLowerCase() : '';
        if (tag === 'input' || tag === 'textarea' || ev.target.isContentEditable) return;
        if (ev.key === 'k' || ev.key === 'K') { ev.preventDefault(); bsCopilot.show(); }
        else if (ev.key === 'Escape' || ev.key === 'Esc') { if (copilotPanelEl.classList.contains('show')) bsCopilot.hide(); postToApp('escape', {}); }
      });

      window.addEventListener('message', (ev) => {
        const data = ev.data || {};
        if (data && data.__tarq_resp) {
          if (data.type==='debugSnapshot') {
            try { const json=JSON.stringify(data.payload,null,2); navigator.clipboard.writeText(json).then(()=>{alert('Debug snapshot copied to clipboard (' + (json.length/1024).toFixed(1) + ' KB)')},()=>{console.log('Debug snapshot:',data.payload);alert('Could not copy automatically — see console.');}); } catch (e) { console.warn(e); }
          }
        }
      });

      window.__tarq_enhancer = { postToApp };
      console.info('Index.html loaded: original TAR-Q preserved via iframe, enhancements and Copilot UI docked and binded to parent controls.');
    })();
  </script>
</body>
</html>
